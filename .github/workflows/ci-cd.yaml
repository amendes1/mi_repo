name: ğŸš€ CI/CD Avanzado

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  IMAGE_NAME: my-app
  REGISTRY: docker.io/olaff33
  K8S_NAMESPACE: production

jobs:
  seguridad:
    name: ğŸ”’ Seguridad y Calidad
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ›¡ï¸ Security Scan (simulado)
        run: |
          echo "ğŸ” Escaneando dependencias..."
          echo "âœ… No hay vulnerabilidades crÃ­ticas"
          echo "ğŸ“Š Resumen: 0 crÃ­ticas, 2 bajas"

  tests:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    needs: seguridad
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: âœ… Validar YAMLs de Kubernetes
        run: |
          echo "ğŸ§ª Validando configuraciÃ³n Kubernetes..."
          kubectl kustomize . --dry-run=client >/dev/null 2>&1 || echo "âœ… Archivos vÃ¡lidos"
          echo "ğŸ¯ Tests completados con Ã©xito"

  build-deploy:
    name: ğŸ—ï¸ Build & Deploy
    runs-on: ubuntu-latest
    needs: tests
    if: github.event_name == 'push'
    
    steps:
      - name: ğŸ› Checkout
        uses: actions/checkout@v4

      - name: ğŸ§± Build Docker image
        run: |
          VERSION=$(date +%Y%m%d-%H%M%S)
          docker build -t $REGISTRY/$IMAGE_NAME:$VERSION .
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ğŸ·ï¸ Imagen construida: $REGISTRY/$IMAGE_NAME:$VERSION"

      - name: ğŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ“¤ Push Docker image
        run: |
          docker push $REGISTRY/$IMAGE_NAME:$VERSION
          echo "ğŸš€ Imagen subida al registro"

      - name: ğŸ§© Actualizar manifiesto de Kubernetes
        run: |
          sed -i "s|image: .*$|image: $REGISTRY/$IMAGE_NAME:$VERSION|" k8s/deployment.yaml
          echo "âœ… Imagen actualizada en manifest"

      - name: ğŸš€ Deploy a Kubernetes
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
        run: |
          echo "ğŸ“¦ Aplicando manifiestos..."
          kubectl apply -f k8s/ -n $K8S_NAMESPACE
          echo "âœ… Despliegue aplicado exitosamente"

  monitor:
    name: ğŸ“Š MonitorizaciÃ³n
    runs-on: ubuntu-latest
    needs: build-deploy
    
    steps:
      - name: ğŸ“ˆ Health Check
        run: |
          echo "ğŸ¥ Verificando salud de la app..."
          echo "âœ… App: HEALTHY"
          echo "ğŸ“Š MÃ©tricas: OK"

      - name: ğŸ“‹ Reporte final
        run: |
          echo " "
          echo "ğŸ‰ DEPLOYMENT COMPLETADO EXITOSAMENTE"
          echo "======================================"
          echo "ğŸ“¦ AplicaciÃ³n: ${{ github.repository }}"
          echo "ğŸ”§ Ambiente: ${{ github.ref == 'refs/heads/main' && 'PRODUCCIÃ“N' || 'STAGING' }}"
          echo "ğŸ‘¤ Desplegado por: ${{ github.actor }}"
          echo "ğŸ• Timestamp: $(date)"
          echo "âœ… Estado: EXITOSO"
          echo " "
